#!/bin/bash

e="" # Set to echo for dry run

# PCLOCK?
$e nvapoke 0x1371c8 0x00030000
$e nvapoke 0x1371cc 0x00030000
$e nvapeek 0x137360 # was 3, but should already be 1, why?
$e nvapoke 0x137360 1

# PIBUS?
$e nvapoke 0x122310 0x00000800
$e nvapoke 0x12232c 0x00100064
$e nvapoke 0x122330 0x00100064
$e nvapoke 0x122334 0x00100064
$e nvapoke 0x122348 0x00000100

# PMFB (once)
$e nvapoke 0x17e820 0x036f0000 # was 37f
$e nvapoke 0x17e900 0x00056c00 # was 76800
$e nvapoke 0x17e934 0x1c008440 # was 0x1d00883a
$e nvapoke 0x17ea00 8
$e nvapoke 0x17e8c0 0x3f000ff3 # was .*fe3
$e nvapoke 0x17e858 0xfc407430

# PFFB
$e nvapoke 0x100b44 0x00010001
$e nvapoke 0x100d74 0x0ff0101d # was 0x0ff01023

# PBFB_BROADCAST
$e nvapoke 0x10f440 0x22f84f10 # was 0x22442410

# PFFB
$e nvapoke 0x100d10 0x42 # was 0xf00000
$e nvapoke 0x100d30 0x42 # was 0xf00000
$e nvapoke 0x100d3c 0x42 # was 0xf00000
$e nvapoke 0x100d48 0x42 # was 0xf00000
$e nvapoke 0x100d1c 0x42 # was 0xf00000
$e nvapoke 0x100c98 0x4242

# PBFB_BROADCAST
$e nvapoke 0x10f000 0x42

# More PMFB
$e nvapoke 0x17e030 0x44
$e nvapoke 0x17e040 0x44
$e nvapoke 0x17ea60 0x44
$e nvapoke 0x17ea68 0x44
$e nvapoke 0x17ea70 0x44
$e nvapoke 0x17ea78 0x44

# PBFB_BROADCAST
$e nvapoke 0x10f8f4 0x212100a7

# And the actual reclock..

$e nvapoke 1548 0x80000102

name=`mktemp`

cat > "${name}" << EOF
0x00000000 0x00000000 0x00000000
0x00000100 0x000000ff 0xffffffff
0x00000200 0x00000055 0x55555555
0x00000300 0x000000aa 0xaaaaaaaa
0x00000400 0x00000033 0x33333333
0x00000500 0x000000cc 0xcccccccc
0x00000600 0x00000000 0xf0f0f0f0
0x00000700 0x000000ff 0x0f0f0f0f
0x00000800 0x000000ff 0x00ff00ff
0x00000900 0x00000000 0xff00ff00
0x00000a00 0x000000ff 0x0000ffff
0x00000b00 0x00000000 0xffff0000
0x00000c00 0x00000000 0x00000000
0x00000d00 0x000000ff 0xffffffff
0x00000e00 0x00000055 0x55555555
0x00000f00 0x000000aa 0xaaaaaaaa
0x00001000 0x00000033 0x33333333
0x00001100 0x000000cc 0xcccccccc
0x00001200 0x00000000 0xf0f0f0f0
0x00001300 0x000000ff 0x0f0f0f0f
0x00001400 0x000000ff 0x00ff00ff
0x00001500 0x00000000 0xff00ff00
0x00001600 0x000000ff 0x0000ffff
0x00001700 0x00000000 0xffff0000
0x00001800 0x00000000 0x00000000
0x00001900 0x000000ff 0xffffffff
0x00001a00 0x00000055 0x55555555
0x00001b00 0x000000aa 0xaaaaaaaa
0x00001c00 0x00000033 0x33333333
0x00001d00 0x000000cc 0xcccccccc
0x00001e00 0x00000000 0xf0f0f0f0
0x00001f00 0x000000ff 0x0f0f0f0f
0x00002000 0x000000ff 0x00ff00ff
0x00002100 0x00000000 0xff00ff00
0x00002200 0x000000ff 0x0000ffff
0x00002300 0x00000000 0xffff0000
0x00002400 0x00000000 0x00000000
0x00002500 0x000000ff 0xffffffff
0x00002600 0x00000055 0x55555555
0x00002700 0x000000aa 0xaaaaaaaa
0x00002800 0x00000033 0x33333333
0x00002900 0x000000cc 0xcccccccc
0x00002a00 0x00000000 0xf0f0f0f0
0x00002b00 0x000000ff 0x0f0f0f0f
0x00002c00 0x000000ff 0x00ff00ff
0x00002d00 0x00000000 0xff00ff00
0x00002e00 0x000000ff 0x0000ffff
0x00002f00 0x00000000 0xffff0000
EOF

while read x y z; do
	$e nvapoke 0x10f968 $x
	$e nvapoke 0x10f96c $x

	$e nvapoke 0x10f920 $(printf 0x%08x $(($y | 0x100)))
	$e nvapoke 0x10f924 $(printf 0x%08x $(($y | 0x100)))

	$e nvapoke 0x10f918 $z
	$e nvapoke 0x10f91c $z

	$e nvapoke 0x10f920 $y
	$e nvapoke 0x10f924 $y

	$e nvapoke 0x10f918 $z
	$e nvapoke 0x10f91c $z
done < "${name}"

rm "${name}"

# What is this? Bus training?
$e nvapeek 0x132000
$e nvapoke 0x132000 0x18000002
$e nvapoke 0x132000 0x18000000
$e nvapeek 0x132000
$e nvapeek 0x132018

# PBFB_BROADCAST again, might also be
# for training purposes
$e nvapeek 0x10fe20
$e nvapeek 0x10fe24
$e nvapoke 0x10fe20 0x20000002
$e nvapoke 0x10fe20 0x20000000

$e nvapeek 0x132020

$e ./gen

$e nvapeek 0x10f824 #     7fd4
$e nvapoke 0x10f824 0x00007fd4

$e nvapoke 0x001548 0x102

$e nvapeek 0x10f468 #     1005
$e nvapoke 0x10f468 0x00020020 

$e nvapeek 0x10f420 #       42
$e nvapoke 0x10f420 0x00000043

$e nvapeek 0x10f430 #       40
$e nvapoke 0x10f430 0x00000041

$e nvapeek 0x10f400 #     1707
$e nvapoke 0x10f400 0x0000171f

$e nvapeek 0x10f410 #      307
$e nvapoke 0x10f410 0x00000107

$e nvapeek 0x10f444 # 04cc009f
$e nvapoke 0x10f444 0x04cc883f

$e nvapoke 0x001548 0x101

